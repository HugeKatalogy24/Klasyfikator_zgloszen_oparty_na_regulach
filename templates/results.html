{% extends "base.html" %}

{% block title %}Wyniki Analizy - {{ start_date }} do {{ end_date }}{% endblock %}

{% block content %}
<style>
.refresh-progress-container {
    background: var(--primary-card-bg, #161b22);
    border: 1px solid var(--border-color, #30363d);
    color: var(--text-primary, #c9d1d9);
    padding: 24px;
    margin: 0 0 30px 0;
    border-radius: 12px;
    box-shadow: var(--shadow-medium, 0 8px 24px rgba(0, 0, 0, 0.4));
}

.refresh-progress-content {
    max-width: 100%;
    margin: 0 auto;
}

.refresh-progress-container .progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.refresh-progress-container .progress-header h3 {
    margin: 0;
    font-size: 1.1em;
    font-weight: 600;
    color: var(--text-primary, #c9d1d9);
    display: flex;
    align-items: center;
    gap: 10px;
}

.refresh-progress-container .progress-bar {
    background: var(--bg-secondary, #0d1117);
    border: 1px solid var(--border-color, #30363d);
    border-radius: 6px;
    height: 12px;
    overflow: hidden;
    margin-bottom: 12px;
}

.refresh-progress-container .progress-fill {
    background: linear-gradient(90deg, var(--accent-blue, #58a6ff), var(--accent-green, #2ea043));
    height: 100%;
    border-radius: 6px;
    transition: width 0.3s ease;
    width: 0%;
    box-shadow: 0 0 10px rgba(88, 166, 255, 0.3);
}

.refresh-progress-container .progress-details {
    display: flex;
    justify-content: space-between;
    font-size: 0.9em;
    color: var(--text-secondary, #8b949e);
}

/* Sekcja wykresu pewno≈õci klasyfikacji */
.chart-section {
    background: linear-gradient(135deg, rgba(26, 26, 46, 0.9) 0%, rgba(22, 33, 62, 0.9) 100%);
    border-radius: 12px;
    padding: 25px;
    margin: 30px 0;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.chart-section h2 {
    color: #e0e0e0;
    margin-bottom: 20px;
    font-size: 1.4em;
    font-weight: 600;
}

.chart-container {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 8px;
    padding: 15px;
}

.confidence-stats {
    display: flex;
    justify-content: center;
    gap: 40px;
    margin-top: 20px;
    padding: 15px;
    background: rgba(102, 126, 234, 0.1);
    border-radius: 8px;
    flex-wrap: wrap;
}

.confidence-stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
}

.confidence-stat-item .stat-label {
    color: #a0a0a0;
    font-size: 0.85em;
}

.confidence-stat-item .stat-value {
    color: #667eea;
    font-size: 1.3em;
    font-weight: 600;
}

@media (max-width: 600px) {
    .confidence-stats {
        gap: 20px;
    }
    
    .confidence-stat-item .stat-value {
        font-size: 1.1em;
    }
}
</style>

<div class="results-container">
    <!-- Header z nawigacjƒÖ i akcjami -->
    <div class="results-header">
        <div class="header-info">
            <h1>Wyniki Analizy</h1>
            <p class="analysis-period">Okres: {{ start_date }} - {{ end_date }}</p>
            <nav class="breadcrumbs">
                <a href="{{ url_for('index') }}" class="breadcrumb-link">üè† Strona g≈Ç√≥wna</a>
                <span class="breadcrumb-separator">‚Üí</span>
                <span class="breadcrumb-current">Wyniki analizy</span>
            </nav>
        </div>
        <div class="header-actions">
            <div class="action-buttons">
                <a href="{{ url_for('export_csv') }}" class="export-btn">
                    üìä Eksportuj CSV
                </a>
                <button id="refreshBtn" class="refresh-btn">
                    üîÑ Od≈õwie≈º dane
                </button>
                <a href="{{ url_for('index') }}" class="back-link">
                    ‚Üê Nowa analiza
                </a>
            </div>
        </div>
    </div>

    <!-- Pasek postƒôpu od≈õwie≈ºania (ukryty poczƒÖtkowo) -->
    <div id="refreshProgressContainer" class="refresh-progress-container" style="display: none;">
        <div class="refresh-progress-content">
            <div class="progress-header">
                <h3>üîÑ Od≈õwie≈ºanie danych z Jira</h3>
                <span id="refreshProgressText">Przygotowywanie...</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="refreshProgressFill"></div>
            </div>
            <div class="progress-details">
                <span id="refreshProgressPercentage">0%</span>
                <span id="refreshProgressEta">Szacowany czas: obliczanie...</span>
            </div>
        </div>
    </div>

    <!-- G≈Ç√≥wne statystyki - CSS Grid Cards -->
    <div class="stats-section">
        <h2>üìà Dashboard Podsumowanie</h2>
        <div class="stats-grid">
            <div class="stat-card primary">
                <div class="stat-icon">üìä</div>
                <div class="stat-content">
                    <div class="stat-number">{{ stats.total_issues }}</div>
                    <div class="stat-label">≈ÅƒÖczna ilo≈õƒá zg≈Çosze≈Ñ</div>
                    <div class="stat-subtitle">Wszystkie przeanalizowane zg≈Çoszenia</div>
                </div>
            </div>

            <div class="stat-card success">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-content">
                    <div class="stat-number">{{ stats.classified_count }}</div>
                    <div class="stat-label">Sklasyfikowane</div>
                    <div class="stat-subtitle">Automatycznie rozpoznane</div>
                </div>
            </div>

            <div class="stat-card success">
                <div class="stat-icon">üìà</div>
                <div class="stat-content">
                    <div class="stat-number">{{ "%.1f"|format(stats.classification_rate) }}%</div>
                    <div class="stat-label">Pokrycie klasyfikacji</div>
                    <div class="stat-subtitle">Procent sklasyfikowanych</div>
                </div>
            </div>

            <!-- Karta z czasem analizy -->
            <div class="stat-card accent">
                <div class="stat-icon">üìÖ</div>
                <div class="stat-content">
                    <div class="stat-number">{{ ((end_date | to_datetime) - (start_date | to_datetime)).days + 1 }}</div>
                    <div class="stat-label">Dni analizy</div>
                    <div class="stat-subtitle">{{ start_date }} - {{ end_date }}</div>
                </div>
            </div>

            <!-- Karta ze ≈õredniƒÖ dziennƒÖ -->
            <div class="stat-card info">
                <div class="stat-icon">üìà</div>
                <div class="stat-content">
                    <div class="stat-number">{{ "%.1f"|format(stats.total_issues / stats.actual_days) }}</div>
                    <div class="stat-label">≈örednia dzienna</div>
                    <div class="stat-subtitle">Zg≈Çosze≈Ñ na dzie≈Ñ ({{ stats.actual_days }} dni)</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sekcja wizualizacji - Dashboard -->
    <div class="dashboard-charts-section" style="display: grid; grid-template-columns: 1fr; gap: 30px; margin: 30px 0;">

        <!-- 2. Trend Zg≈Çosze≈Ñ w Czasie -->
        <div class="chart-section">
            <h2>üìà Trend Zg≈Çosze≈Ñ w Czasie</h2>
            <p class="chart-description" style="color: #a0a0a0; margin-bottom: 15px;">Liczba zg≈Çosze≈Ñ w poszczeg√≥lnych dniach analizowanego okresu.</p>
            <div class="chart-container">
                <div id="trendChart" style="width: 100%; height: 400px;"></div>
            </div>
        </div>
        
    </div>

    <!-- Sekcja typ√≥w zg≈Çosze≈Ñ -->
    <div class="issue-types-section">
        <h2>üìã Typy Zg≈Çosze≈Ñ</h2>
        <div class="issue-types-grid">
            {% for issue_type, count in stats.issue_type_stats.items() %}
            <div class="issue-type-card">
                <div class="issue-type-content">
                    <div class="issue-type-name">{{ issue_type }}</div>
                    <div class="issue-type-count">{{ count }}</div>
                    <div class="issue-type-percentage">{{ "%.1f"|format((count / stats.total_issues) * 100) }}%</div>
                </div>
                <div class="issue-type-bar">
                    <div class="issue-type-progress" style="width: {{ (count / stats.total_issues) * 100 }}%"></div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- G≈Ç√≥wna zawarto≈õƒá - tabela problem√≥w -->
    <div class="content-section">
        <div class="problems-section">
            <div class="card">
                <div class="card-header">
                    <h3>üî• Top Problemy</h3>
                    <p class="card-subtitle">Ranking najczƒôstszych kategorii problem√≥w</p>
                </div>
                
                <div class="table-container">
                    <table class="problems-table">
                        <thead>
                            <tr>
                                <th>Pozycja</th>
                                <th>Kategoria problemu</th>
                                <th>DominujƒÖcy typ</th>
                                <th>Ilo≈õƒá zg≈Çosze≈Ñ</th>
                                <th>Procent ca≈Ço≈õci</th>
                                <th>Udzia≈Ç w sklasyfikowanych</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set ns = namespace(rank=1) %}
                            {% for category, count in stats.top_problems.items() %}
                            {% if category != 'inne' and count > 0 %}
                            <tr class="problem-row">
                                <td class="rank-cell">
                                    <span class="rank-badge {% if ns.rank <= 3 %}rank-top{% endif %}">{{ ns.rank }}</span>
                                </td>
                                <td class="category-cell">
                                    <div class="category-name">{{ category|e }}</div>
                                </td>
                                <td class="issue-type-cell">
                                    <div class="issue-type-info">
                                        <span class="issue-type-name">{{ stats.category_dominant_types.get(category, 'Unknown')|e }}</span>
                                    </div>
                                </td>
                                <td class="count-cell">
                                    <span class="count-number">{{ count }}</span>
                                </td>
                                <td class="percent-cell">
                                    <span class="percent-number">{{ "%.1f"|format((count / stats.total_issues) * 100) }}%</span>
                                </td>
                                <td class="classified-percent-cell">
                                    <span class="classified-percent">{{ "%.1f"|format((count / stats.classified_count) * 100) }}%</span>
                                    <div class="mini-progress">
                                        <div class="mini-progress-bar" style="width: {{ (count / stats.classified_count) * 100 }}%"></div>
                                    </div>
                                </td>
                            </tr>
                            {% set ns.rank = ns.rank + 1 %}
                            {% endif %}
                            {% endfor %}
                            
                            <!-- Wiersz dla "inne" na ko≈Ñcu -->
                            {% if 'inne' in stats.top_problems and stats.top_problems['inne'] > 0 %}
                            <tr class="problem-row other-row">
                                <td class="rank-cell">
                                    <span class="rank-badge other">-</span>
                                </td>
                                <td class="category-cell">
                                    <div class="category-name other">Inne (niesklasyfikowane)</div>
                                </td>
                                <td class="issue-type-cell">
                                    <div class="issue-type-info">
                                        <span class="issue-type-name">R√≥≈ºne</span>
                                    </div>
                                </td>
                                <td class="count-cell">
                                    <span class="count-number">{{ stats.top_problems['inne'] }}</span>
                                </td>
                                <td class="percent-cell">
                                    <span class="percent-number">{{ "%.1f"|format((stats.top_problems['inne'] / stats.total_issues) * 100) }}%</span>
                                </td>
                                <td class="classified-percent-cell">
                                    <span class="classified-percent">-</span>
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Sekcja restauracji -->
    <div class="content-section">
        <div class="sites-section">
            <div class="card">
                <div class="card-header">
                    <h3>üè™ Najczƒô≈õciej zg≈ÇaszajƒÖce restauracje</h3>
                    <p class="card-subtitle">Ranking lokalizacji z najwiƒôkszƒÖ liczbƒÖ zg≈Çosze≈Ñ w wybranym okresie</p>
                </div>
                
                <div class="table-container">
                    <table class="sites-table">
                        <thead>
                            <tr>
                                <th title="Pozycja w rankingu" class="sortable" data-sort="position">
                                    Pozycja <span class="sort-indicator">‚Üï</span>
                                </th>
                                <th title="Numer restauracji wyciƒÖgniƒôty z pola reporter" class="sortable" data-sort="number">
                                    Numer restauracji <span class="sort-indicator">‚Üï</span>
                                </th>
                                <th title="Nazwa restauracji wyciƒÖgniƒôta z pola reporter" class="sortable" data-sort="name">
                                    Nazwa restauracji <span class="sort-indicator">‚Üï</span>
                                </th>
                                <th title="Liczba zg≈Çosze≈Ñ typu Incydent" class="sortable" data-sort="incidents">
                                    Ilo≈õƒá incydent√≥w <span class="sort-indicator">‚Üï</span>
                                </th>
                                <th title="Liczba zg≈Çosze≈Ñ typu Us≈Çuga" class="sortable" data-sort="services">
                                    Ilo≈õƒá us≈Çug <span class="sort-indicator">‚Üï</span>
                                </th>
                                <th title="Liczba zg≈Çosze≈Ñ typu Powa≈ºny Incydent" class="sortable" data-sort="critical">
                                    Ilo≈õƒá powa≈ºnych incydent√≥w <span class="sort-indicator">‚Üï</span>
                                </th>
                                <th title="Ca≈Çkowita liczba zg≈Çosze≈Ñ z tej restauracji" class="sortable" data-sort="count">
                                    Ilo≈õƒá zg≈Çosze≈Ñ <span class="sort-indicator">‚Üï</span>
                                </th>
                                <th title="Procent wzglƒôdem wszystkich zg≈Çosze≈Ñ w analizowanym okresie" class="sortable" data-sort="percent">
                                    Procent wszystkich zg≈Çosze≈Ñ <span class="sort-indicator">‚Üï</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set ns = namespace(rank=1) %}
                            {% for site, info in stats.top_sites.items() %}
                            {% if site != 'Inne restauracje' and info.count > 0 %}
                            <tr class="site-row">
                                <td class="rank-cell">
                                    <span class="rank-badge {% if ns.rank <= 3 %}rank-top{% endif %}">{{ ns.rank }}</span>
                                </td>
                                <td class="site-cell">
                                    <div class="site-name">{{ site }}</div>
                                </td>
                                <td class="site-cell">
                                    <div class="site-name">{{ info.name }}</div>
                                </td>
                                <td class="count-cell">
                                    <span class="count-number incidents">{{ info.incidents }}</span>
                                </td>
                                <td class="count-cell">
                                    <span class="count-number services">{{ info.services }}</span>
                                </td>
                                <td class="count-cell">
                                    <span class="count-number critical">{{ info.critical_incidents }}</span>
                                </td>
                                <td class="count-cell">
                                    <span class="count-number">{{ info.count }}</span>
                                </td>
                                <td class="percent-cell">
                                    <span class="percent-number">{{ "%.1f"|format((info.count / stats.total_issues) * 100) }}%</span>
                                </td>
                            </tr>
                            {% set ns.rank = ns.rank + 1 %}
                            {% endif %}
                            {% endfor %}
                            
                            <!-- Wiersz dla "inne restauracje" na ko≈Ñcu -->
                            {% if 'Inne restauracje' in stats.top_sites and stats.top_sites['Inne restauracje'].count > 0 %}
                            <tr class="site-row other-row">
                                <td class="rank-cell">
                                    <span class="rank-badge other">-</span>
                                </td>
                                <td class="site-cell">
                                    <div class="site-name other">-</div>
                                </td>
                                <td class="site-cell">
                                    <div class="site-name other">Inne restauracje</div>
                                </td>
                                <td class="count-cell">
                                    <span class="count-number incidents">{{ stats.top_sites['Inne restauracje'].incidents }}</span>
                                </td>
                                <td class="count-cell">
                                    <span class="count-number services">{{ stats.top_sites['Inne restauracje'].services }}</span>
                                </td>
                                <td class="count-cell">
                                    <span class="count-number critical">{{ stats.top_sites['Inne restauracje'].critical_incidents }}</span>
                                </td>
                                <td class="count-cell">
                                    <span class="count-number">{{ stats.top_sites['Inne restauracje'].count }}</span>
                                </td>
                                <td class="percent-cell">
                                    <span class="percent-number">{{ "%.1f"|format((stats.top_sites['Inne restauracje'].count / stats.total_issues) * 100) }}%</span>
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

<!-- JavaScript dla interakcji -->
<script nonce="{{ csp_nonce }}">
// Globalna zmienna do ≈õledzenia stanu od≈õwie≈ºania
let refreshInProgress = false;

document.addEventListener('DOMContentLoaded', function() {
    // Obs≈Çuga przycisku od≈õwie≈ºania
    const refreshBtn = document.getElementById('refreshBtn');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', refreshData);
    }

    // Animacja licznik√≥w statystyk
    const statNumbers = document.querySelectorAll('.stat-number');
    statNumbers.forEach(element => {
        const finalValue = element.textContent;
        if (!isNaN(finalValue) && !finalValue.includes('%')) {
            animateCounter(element, 0, parseInt(finalValue), 1000);
        }
    });

    // Hover effects dla wierszy tabeli
    const problemRows = document.querySelectorAll('.problem-row');
    problemRows.forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.transform = 'translateX(5px)';
        });
        row.addEventListener('mouseleave', function() {
            this.style.transform = 'translateX(0)';
        });
    });

    // Sortowanie tabeli restauracji
    const sortableHeaders = document.querySelectorAll('.sites-table .sortable');
    sortableHeaders.forEach(header => {
        header.addEventListener('click', function() {
            const sortType = this.dataset.sort;
            const table = this.closest('table');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr:not(.other-row)'));
            const otherRow = tbody.querySelector('.other-row');
            
            // Determine sort direction
            const currentIndicator = this.querySelector('.sort-indicator');
            const isAscending = currentIndicator.textContent === '‚Üï' || currentIndicator.textContent === '‚Üì';
            
            // Clear all indicators
            sortableHeaders.forEach(h => h.querySelector('.sort-indicator').textContent = '‚Üï');
            
            // Sort rows
            rows.sort((a, b) => {
                let aValue, bValue;
                
                switch(sortType) {
                    case 'position':
                        aValue = parseInt(a.querySelector('.rank-badge').textContent);
                        bValue = parseInt(b.querySelector('.rank-badge').textContent);
                        break;
                    case 'name':
                        aValue = a.querySelector('.site-name').textContent.toLowerCase();
                        bValue = b.querySelector('.site-name').textContent.toLowerCase();
                        break;
                    case 'count':
                        aValue = parseInt(a.querySelector('.count-number').textContent);
                        bValue = parseInt(b.querySelector('.count-number').textContent);
                        break;
                    case 'percent':
                        aValue = parseFloat(a.querySelector('.percent-number').textContent.replace('%', ''));
                        bValue = parseFloat(b.querySelector('.percent-number').textContent.replace('%', ''));
                        break;
                }
                
                if (typeof aValue === 'string') {
                    return isAscending ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
                } else {
                    return isAscending ? aValue - bValue : bValue - aValue;
                }
            });
            
            // Update indicator
            currentIndicator.textContent = isAscending ? '‚Üë' : '‚Üì';
            
            // Re-append sorted rows
            rows.forEach(row => tbody.appendChild(row));
            
            // Keep "other" row at the end
            if (otherRow) {
                tbody.appendChild(otherRow);
            }
        });
    });
});

function animateCounter(element, start, end, duration) {
    const range = end - start;
    const startTime = Date.now();
    
    function updateCounter() {
        const now = Date.now();
        const elapsed = now - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const easeOutProgress = 1 - Math.pow(1 - progress, 3);
        const current = Math.round(start + (range * easeOutProgress));
        
        element.textContent = current.toLocaleString();
        
        if (progress < 1) {
            requestAnimationFrame(updateCounter);
        } else {
            element.textContent = end.toLocaleString();
        }
    }
    
    updateCounter();
}

function refreshData() {
    console.log('üîÑ Rozpoczynanie od≈õwie≈ºania danych...');
    
    if (typeof refreshInProgress !== 'undefined' && refreshInProgress) {
        alert('Od≈õwie≈ºanie ju≈º trwa. Proszƒô poczekaƒá.');
        return;
    }
    
    if (confirm('Czy na pewno chcesz od≈õwie≈ºyƒá dane z Jira? To mo≈ºe potrwaƒá kilka minut.')) {
        refreshInProgress = true;
        showRefreshProgress();
        
        // Wy≈õlij ≈ºƒÖdanie AJAX do endpoint'u /analyze
        const formData = new FormData();
        formData.append('start_date', '{{ start_date }}');
        formData.append('end_date', '{{ end_date }}');
        formData.append('refresh_data', 'on');
        formData.append('csrf_token', window.csrfToken || '{{ csrf_token }}');
        
        console.log('üì§ Wysy≈Çanie ≈ºƒÖdania do /analyze...');
        
        fetch('{{ url_for("analyze") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            console.log('üì• Otrzymano odpowied≈∫:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('üìä Dane z serwera:', data);
            
            if (data.success) {
                console.log('‚úÖ Analiza uruchomiona, ID:', data.analysis_id);
                // Rozpocznij ≈õledzenie postƒôpu analizy
                trackAnalysisProgress(data.analysis_id);
            } else {
                throw new Error(data.errors ? data.errors.join(', ') : 'Nieznany b≈ÇƒÖd');
            }
        })
        .catch(error => {
            console.error('‚ùå B≈ÇƒÖd podczas uruchamiania analizy:', error);
            alert('B≈ÇƒÖd podczas uruchamiania analizy: ' + error.message);
            refreshInProgress = false;
            hideRefreshProgress();
        });
    }
}

// Funkcja ≈õledzenia postƒôpu analizy
function trackAnalysisProgress(analysisId) {
    console.log('üìä Rozpoczynanie ≈õledzenia postƒôpu dla:', analysisId);
    
    const checkProgress = () => {
        console.log('üîç Sprawdzanie postƒôpu...');
        
        fetch(`/api/analysis-progress/${analysisId}`)
            .then(response => {
                console.log('üì° Status odpowiedzi:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('üìà Dane postƒôpu:', data);
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Aktualizuj pasek postƒôpu
                updateRefreshProgress(
                    data.progress,
                    data.status,
                    data.eta_seconds > 0 ? `Pozosta≈Ço: ${data.eta_seconds}s` : 'Ko≈Ñcowe operacje...'
                );
                
                if (data.completed) {
                    console.log('‚úÖ Analiza zako≈Ñczona!');
                    if (data.redirect_url) {
                        console.log('üîó Przekierowanie do:', data.redirect_url);
                        // Przekieruj do wynik√≥w
                        setTimeout(() => {
                            window.location.href = data.redirect_url;
                        }, 1000);
                    } else {
                        throw new Error('Analiza zako≈Ñczona, ale brak URL przekierowania');
                    }
                } else {
                    // Kontynuuj ≈õledzenie co sekundƒô
                    setTimeout(checkProgress, 1000);
                }
            })
            .catch(error => {
                console.error('‚ùå B≈ÇƒÖd podczas ≈õledzenia postƒôpu:', error);
                alert('B≈ÇƒÖd podczas analizy: ' + error.message);
                refreshInProgress = false;
                hideRefreshProgress();
            });
    };
    
    // Rozpocznij ≈õledzenie
    checkProgress();
}

function hideRefreshProgress() {
    const progressContainer = document.getElementById('refreshProgressContainer');
    if (progressContainer) {
        progressContainer.style.display = 'none';
    }
}

function showRefreshProgress() {
    const progressContainer = document.getElementById('refreshProgressContainer');
    if (progressContainer) {
        progressContainer.style.display = 'block';
        // Przewi≈Ñ na g√≥rƒô ≈ºeby pasek by≈Ç widoczny
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

function updateRefreshProgress(percentage, statusText, etaText) {
    const progressFill = document.getElementById('refreshProgressFill');
    const progressText = document.getElementById('refreshProgressText');
    const progressPercentage = document.getElementById('refreshProgressPercentage');
    const progressEta = document.getElementById('refreshProgressEta');
    
    if (progressFill) progressFill.style.width = percentage + '%';
    if (progressText) progressText.textContent = statusText;
    if (progressPercentage) progressPercentage.textContent = Math.round(percentage) + '%';
    if (progressEta) progressEta.textContent = etaText;
}

async function simulateRefreshProgress() {
    // Oblicz czas na podstawie zakresu dat
    const startDate = new Date('{{ start_date }}');
    const endDate = new Date('{{ end_date }}');
    const timeDiff = Math.abs(endDate - startDate);
    const daysDiff = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));

    // 8 sekund na dzie≈Ñ, minimum 15 sekund, maksimum 540 sekund
    let totalTime = Math.max(15, Math.min(daysDiff * 8, 540));
    
    const steps = [
        { percent: 20, text: '≈ÅƒÖczenie z API Jira...', duration: 0.15 },
        { percent: 45, text: 'Pobieranie zaktualizowanych zg≈Çosze≈Ñ...', duration: 0.35 },
        { percent: 70, text: 'Ponowna klasyfikacja problem√≥w...', duration: 0.25 },
        { percent: 90, text: 'Aktualizacja statystyk...', duration: 0.15 },
        { percent: 100, text: 'Przekierowanie do wynik√≥w...', duration: 0.1 }
    ];
    
    let totalElapsed = 0;
    
    for (let i = 0; i < steps.length; i++) {
        const step = steps[i];
        const stepTime = totalTime * step.duration;
        const remainingTime = Math.max(0, totalTime - totalElapsed);
        const etaText = remainingTime > 0 ? `Pozosta≈Ço: ${Math.ceil(remainingTime)}s` : 'Zako≈Ñczenie...';
        
        updateRefreshProgress(step.percent, step.text, etaText);
        
        await new Promise(resolve => setTimeout(resolve, stepTime * 1000));
        totalElapsed += stepTime;
    }
}

// Dane do wykres√≥w Dashboard
const treemapData = {{ stats.treemap_data | tojson }};
const dailyTrend = {{ stats.daily_trend | tojson }};
const dailyCategoryTrend = {{ stats.daily_category_trend | tojson }};

function renderDashboardCharts() {
    console.log("Rendering Dashboard Charts...");
    console.log("Daily Trend Data:", dailyTrend);

    // 2. Render Trend Chart
    if (dailyTrend && Object.keys(dailyTrend).length > 0) {
        const dates = Object.keys(dailyTrend).sort();
        const totalCounts = dates.map(d => dailyTrend[d]);
        
        const traces = [];
        
        // Linia ca≈Çkowita
        traces.push({
            x: dates,
            y: totalCounts,
            type: 'scatter',
            mode: 'lines+markers',
            name: '≈ÅƒÖcznie',
            line: {
                color: '#58a6ff',
                width: 3,
                shape: 'spline'
            },
            marker: {
                size: 8,
                color: '#58a6ff'
            }
        });
        
        // Obliczanie linii regresji (Trend Liniowy)
        if (dates.length > 1) {
            const xValues = dates.map(d => new Date(d).getTime());
            const yValues = totalCounts;
            const n = xValues.length;
            
            let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
            for (let i = 0; i < n; i++) {
                sumX += xValues[i];
                sumY += yValues[i];
                sumXY += xValues[i] * yValues[i];
                sumXX += xValues[i] * xValues[i];
            }
            
            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            
            const regressionY = xValues.map(x => slope * x + intercept);
            
            traces.push({
                x: dates,
                y: regressionY,
                type: 'scatter',
                mode: 'lines',
                name: 'Linia trendu (Regresja)',
                line: {
                    color: 'rgba(255, 255, 255, 0.3)',
                    width: 2,
                    dash: 'dash'
                },
                hoverinfo: 'skip'
            });
        }

        // Linie dla kategorii (opcjonalnie)
        if (dailyCategoryTrend) {
            const colors = ['#2ea043', '#f85149', '#db61a2', '#d29922', '#8b949e'];
            let i = 0;
            for (const [cat, trend] of Object.entries(dailyCategoryTrend)) {
                const catCounts = dates.map(d => trend[d] || 0);
                traces.push({
                    x: dates,
                    y: catCounts,
                    type: 'scatter',
                    mode: 'lines',
                    name: cat,
                    line: {
                        width: 2,
                        dash: 'dot',
                        color: colors[i % colors.length]
                    },
                    visible: 'legendonly' // Domy≈õlnie ukryte
                });
                i++;
            }
        }

        const layout = {
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { 
                family: 'Inter, sans-serif',
                color: '#c9d1d9' 
            },
            xaxis: {
                title: 'Data',
                gridcolor: '#30363d',
                zerolinecolor: '#30363d',
                tickfont: { color: '#8b949e' }
            },
            yaxis: {
                title: 'Liczba zg≈Çosze≈Ñ',
                gridcolor: '#30363d',
                zerolinecolor: '#30363d',
                tickfont: { color: '#8b949e' }
            },
            legend: {
                orientation: 'h',
                y: -0.2,
                font: { color: '#c9d1d9' }
            },
            margin: { t: 20, r: 20, l: 50, b: 50 },
            hovermode: 'x unified'
        };
        
        const config = { responsive: true, displayModeBar: false };
        Plotly.newPlot('trendChart', traces, layout, config);
    } else {
        console.warn("Brak danych dla Trend Chart");
        document.getElementById('trendChart').innerHTML = '<div style="text-align:center; padding: 20px; color: #888;">Brak danych historycznych do wy≈õwietlenia trendu (sprawd≈∫ czy plik zawiera kolumnƒô "created")</div>';
    }
}

// Wywo≈Çaj renderowanie histogramu po za≈Çadowaniu strony
document.addEventListener('DOMContentLoaded', function() {
    // renderConfidenceHistogram(); // Usuniƒôte
    renderDashboardCharts();
});
</script>
{% endblock %}
