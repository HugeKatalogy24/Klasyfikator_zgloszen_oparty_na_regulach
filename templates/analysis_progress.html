{% extends "base.html" %}

{% block title %}Analizator Problem√≥w Jira - Analiza w toku{% endblock %}

{% block content %}
<div class="form-wrapper">
    <h1>üîç Analizator Problem√≥w Jira</h1>
    
    <div class="analysis-header">
        <h2>üìä Analiza w toku</h2>
        <p>Analizujƒô dane z okresu: <strong>{{ start_date }}</strong> do <strong>{{ end_date }}</strong></p>
    </div>

    <!-- Pasek postƒôpu -->
    <div id="progressContainer" class="progress-container">
        <div class="progress-header">
            <h3 id="progressTitle">üìä Pobieranie danych z Jira...</h3>
            <span id="progressText">≈ÅƒÖczenie z serwerem...</span>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-details">
            <span id="progressPercentage">0%</span>
            <span id="progressEta">Szacowany czas: obliczanie...</span>
        </div>
    </div>

    <!-- Komunikat o b≈Çƒôdzie (ukryty poczƒÖtkowo) -->
    <div id="errorContainer" class="error-container" style="display: none;">
        <div class="error-header">
            <h3>‚ùå WystƒÖpi≈Ç b≈ÇƒÖd</h3>
        </div>
        <div class="error-message" id="errorMessage"></div>
        <div class="error-actions">
            <a href="{{ url_for('index') }}" class="btn-primary">
                <span class="btn-icon">üîÑ</span>
                Spr√≥buj ponownie
            </a>
        </div>
    </div>

    <!-- Komunikat o uko≈Ñczeniu (ukryty poczƒÖtkowo) -->
    <div id="completedContainer" class="completed-container" style="display: none;">
        <div class="completed-header">
            <h3>‚úÖ Analiza zako≈Ñczona</h3>
        </div>
        <div class="completed-message">
            <p>Analiza zosta≈Ça pomy≈õlnie zako≈Ñczona. Przekierowujƒô do wynik√≥w...</p>
        </div>
    </div>
</div>

<style>
.analysis-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 30px;
    text-align: center;
}

.analysis-header h2 {
    margin: 0 0 10px 0;
    font-size: 1.5em;
}

.analysis-header p {
    margin: 0;
    opacity: 0.9;
}

.progress-container {
    background: white;
    border-radius: 10px;
    padding: 25px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.progress-header h3 {
    margin: 0;
    color: #333;
    font-size: 1.2em;
}

#progressText {
    color: #666;
    font-size: 0.9em;
}

.progress-bar {
    width: 100%;
    height: 20px;
    background-color: #f0f0f0;
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 15px;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #4CAF50, #45a049);
    border-radius: 10px;
    transition: width 0.5s ease;
    box-shadow: 0 2px 4px rgba(76, 175, 80, 0.3);
}

.progress-details {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.9em;
}

#progressPercentage {
    font-weight: bold;
    color: #333;
}

#progressEta {
    color: #666;
}

.error-container, .completed-container {
    background: white;
    border-radius: 10px;
    padding: 25px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    text-align: center;
}

.error-container {
    border-left: 5px solid #f44336;
}

.completed-container {
    border-left: 5px solid #4CAF50;
}

.error-header h3, .completed-header h3 {
    margin: 0 0 15px 0;
    font-size: 1.3em;
}

.error-message {
    color: #666;
    margin-bottom: 20px;
    padding: 15px;
    background: #ffebee;
    border-radius: 5px;
}

.completed-message {
    color: #666;
    margin-bottom: 20px;
}

.error-actions {
    margin-top: 20px;
}

.btn-primary {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    text-decoration: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.btn-icon {
    font-size: 1.1em;
}

/* Animacja paska postƒôpu */
@keyframes progressGlow {
    0% { box-shadow: 0 2px 4px rgba(76, 175, 80, 0.3); }
    50% { box-shadow: 0 2px 8px rgba(76, 175, 80, 0.6); }
    100% { box-shadow: 0 2px 4px rgba(76, 175, 80, 0.3); }
}

.progress-fill {
    animation: progressGlow 2s ease-in-out infinite;
}
</style>

<script>
const analysisId = '{{ analysis_id }}';
let progressInterval;

// Funkcja do formatowania czasu
function formatTime(seconds) {
    if (seconds < 60) {
        return `${seconds} sekund`;
    } else {
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        return `${minutes}m ${remainingSeconds}s`;
    }
}

// Funkcja do aktualizacji paska postƒôpu
function updateProgress(progress, status, etaSeconds) {
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const progressPercentage = document.getElementById('progressPercentage');
    const progressEta = document.getElementById('progressEta');
    
    progressFill.style.width = progress + '%';
    progressText.textContent = status;
    progressPercentage.textContent = Math.round(progress) + '%';
    
    if (etaSeconds > 0) {
        progressEta.textContent = `Pozosta≈Ço: ${formatTime(etaSeconds)}`;
    } else {
        progressEta.textContent = 'Zako≈Ñczenie...';
    }
}

// Funkcja do sprawdzania postƒôpu
function checkProgress() {
    fetch(`/api/analysis-progress/${analysisId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateProgress(data.progress, data.status, data.eta_seconds);
                
                if (data.completed) {
                    clearInterval(progressInterval);
                    
                    if (data.error) {
                        // Poka≈º b≈ÇƒÖd
                        document.getElementById('progressContainer').style.display = 'none';
                        document.getElementById('errorMessage').textContent = data.error;
                        document.getElementById('errorContainer').style.display = 'block';
                    } else if (data.redirect_url) {
                        // Poka≈º komunikat o uko≈Ñczeniu i przekieruj
                        document.getElementById('progressContainer').style.display = 'none';
                        document.getElementById('completedContainer').style.display = 'block';
                        
                        setTimeout(() => {
                            window.location.href = data.redirect_url;
                        }, 2000);
                    }
                }
            } else {
                clearInterval(progressInterval);
                document.getElementById('progressContainer').style.display = 'none';
                document.getElementById('errorMessage').textContent = data.error || 'Nieznany b≈ÇƒÖd';
                document.getElementById('errorContainer').style.display = 'block';
            }
        })
        .catch(error => {
            console.error('B≈ÇƒÖd podczas sprawdzania postƒôpu:', error);
            clearInterval(progressInterval);
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('errorMessage').textContent = 'B≈ÇƒÖd po≈ÇƒÖczenia z serwerem';
            document.getElementById('errorContainer').style.display = 'block';
        });
}

// Rozpocznij sprawdzanie postƒôpu
document.addEventListener('DOMContentLoaded', function() {
    // Pierwsze sprawdzenie po 1 sekundzie
    setTimeout(checkProgress, 1000);
    
    // Nastƒôpnie sprawdzaj co 2 sekundy
    progressInterval = setInterval(checkProgress, 2000);
});

// Zatrzymaj sprawdzanie gdy u≈ºytkownik opuszcza stronƒô
window.addEventListener('beforeunload', function() {
    if (progressInterval) {
        clearInterval(progressInterval);
    }
});
</script>
{% endblock %}
